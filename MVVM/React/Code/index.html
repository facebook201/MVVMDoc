<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 源码 | MVVM框架集</title>
    <meta name="description" content="飘飘乎如遗世独立 羽化而登仙">
    <link rel="icon" href="/MVVMDoc/pkq.jpeg">
    
    <link rel="preload" href="/MVVMDoc/assets/css/0.styles.a5345176.css" as="style"><link rel="preload" href="/MVVMDoc/assets/js/app.0ce0ee86.js" as="script"><link rel="preload" href="/MVVMDoc/assets/js/7.f7d9a218.js" as="script"><link rel="prefetch" href="/MVVMDoc/assets/js/10.8c942620.js"><link rel="prefetch" href="/MVVMDoc/assets/js/11.22b73831.js"><link rel="prefetch" href="/MVVMDoc/assets/js/12.bc9ef78f.js"><link rel="prefetch" href="/MVVMDoc/assets/js/13.9b0b8518.js"><link rel="prefetch" href="/MVVMDoc/assets/js/14.09b24188.js"><link rel="prefetch" href="/MVVMDoc/assets/js/15.16367390.js"><link rel="prefetch" href="/MVVMDoc/assets/js/16.500fcba6.js"><link rel="prefetch" href="/MVVMDoc/assets/js/17.2160c3ed.js"><link rel="prefetch" href="/MVVMDoc/assets/js/18.a1b98696.js"><link rel="prefetch" href="/MVVMDoc/assets/js/19.3774a35c.js"><link rel="prefetch" href="/MVVMDoc/assets/js/2.a1f8879c.js"><link rel="prefetch" href="/MVVMDoc/assets/js/20.f39149de.js"><link rel="prefetch" href="/MVVMDoc/assets/js/21.9fe5b26c.js"><link rel="prefetch" href="/MVVMDoc/assets/js/22.2676caf5.js"><link rel="prefetch" href="/MVVMDoc/assets/js/23.4b011396.js"><link rel="prefetch" href="/MVVMDoc/assets/js/24.673ebd68.js"><link rel="prefetch" href="/MVVMDoc/assets/js/25.753ad69b.js"><link rel="prefetch" href="/MVVMDoc/assets/js/26.0ecb2d6f.js"><link rel="prefetch" href="/MVVMDoc/assets/js/27.f9450161.js"><link rel="prefetch" href="/MVVMDoc/assets/js/28.17f8fd8b.js"><link rel="prefetch" href="/MVVMDoc/assets/js/29.9faae8cf.js"><link rel="prefetch" href="/MVVMDoc/assets/js/3.c5e28420.js"><link rel="prefetch" href="/MVVMDoc/assets/js/30.bc250b25.js"><link rel="prefetch" href="/MVVMDoc/assets/js/31.bda37d6f.js"><link rel="prefetch" href="/MVVMDoc/assets/js/32.bbbeaf28.js"><link rel="prefetch" href="/MVVMDoc/assets/js/33.873dcf9d.js"><link rel="prefetch" href="/MVVMDoc/assets/js/34.a482e32a.js"><link rel="prefetch" href="/MVVMDoc/assets/js/35.3cb5f8ee.js"><link rel="prefetch" href="/MVVMDoc/assets/js/36.dbefa361.js"><link rel="prefetch" href="/MVVMDoc/assets/js/37.7f28fb99.js"><link rel="prefetch" href="/MVVMDoc/assets/js/38.fcc3ff8b.js"><link rel="prefetch" href="/MVVMDoc/assets/js/39.e5e4a3b7.js"><link rel="prefetch" href="/MVVMDoc/assets/js/4.ba272e01.js"><link rel="prefetch" href="/MVVMDoc/assets/js/40.d7d2ba48.js"><link rel="prefetch" href="/MVVMDoc/assets/js/41.e1072a19.js"><link rel="prefetch" href="/MVVMDoc/assets/js/42.4ae18cf3.js"><link rel="prefetch" href="/MVVMDoc/assets/js/43.bf2c1c95.js"><link rel="prefetch" href="/MVVMDoc/assets/js/44.1754016c.js"><link rel="prefetch" href="/MVVMDoc/assets/js/45.e1be7dad.js"><link rel="prefetch" href="/MVVMDoc/assets/js/46.9afa7bbf.js"><link rel="prefetch" href="/MVVMDoc/assets/js/47.c8447f56.js"><link rel="prefetch" href="/MVVMDoc/assets/js/48.f2aead05.js"><link rel="prefetch" href="/MVVMDoc/assets/js/49.3a579f90.js"><link rel="prefetch" href="/MVVMDoc/assets/js/5.82f5b997.js"><link rel="prefetch" href="/MVVMDoc/assets/js/50.f69ca589.js"><link rel="prefetch" href="/MVVMDoc/assets/js/51.697922a6.js"><link rel="prefetch" href="/MVVMDoc/assets/js/52.f28f99b5.js"><link rel="prefetch" href="/MVVMDoc/assets/js/6.fe6717f0.js"><link rel="prefetch" href="/MVVMDoc/assets/js/8.852896ca.js"><link rel="prefetch" href="/MVVMDoc/assets/js/9.f94093b0.js">
    <link rel="stylesheet" href="/MVVMDoc/assets/css/0.styles.a5345176.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MVVMDoc/" class="home-link router-link-active"><!----> <span class="site-name">MVVM框架集</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Node/Koa/" class="nav-link">Koa</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/basic/" class="nav-link">Vue基础知识</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/global/" class="nav-link">Vue全局设计</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/components/" class="nav-link">Vue组件开发</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/router/" class="nav-link">Vue-Router源码</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/higher/" class="nav-link">Vue进阶知识</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/VueQS/" class="nav-link">Vue面试题</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/VueArticle/" class="nav-link">Vue好文</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/Vue3/" class="nav-link">Vue3</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">React</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/basic/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/Router/" class="nav-link">react-router</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/Redux/" class="nav-link">Redux</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/ReactQS/" class="nav-link">React的相关问题</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/Code/" class="nav-link router-link-exact-active router-link-active">React源码理念</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/MongoDB/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/InterviewQS/" class="nav-link">面试题</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/QSK/" class="nav-link">面试引出的知识</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">TypeScript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/TSC/typescript/" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/TSC/Axios/" class="nav-link">TypeScript封装一个Axios</a></li></ul></div></div> <a href="https://github.com/facebook201/MVVMDoc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Node/Koa/" class="nav-link">Koa</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/basic/" class="nav-link">Vue基础知识</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/global/" class="nav-link">Vue全局设计</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/components/" class="nav-link">Vue组件开发</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/router/" class="nav-link">Vue-Router源码</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/higher/" class="nav-link">Vue进阶知识</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/VueQS/" class="nav-link">Vue面试题</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/VueArticle/" class="nav-link">Vue好文</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Vue/Vue3/" class="nav-link">Vue3</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">React</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/basic/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/Router/" class="nav-link">react-router</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/Redux/" class="nav-link">Redux</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/ReactQS/" class="nav-link">React的相关问题</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/React/Code/" class="nav-link router-link-exact-active router-link-active">React源码理念</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/MongoDB/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/Redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/InterviewQS/" class="nav-link">面试题</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/QSK/" class="nav-link">面试引出的知识</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">TypeScript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/TSC/typescript/" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/MVVMDoc/MVVM/TSC/Axios/" class="nav-link">TypeScript封装一个Axios</a></li></ul></div></div> <a href="https://github.com/facebook201/MVVMDoc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="load-success"><div id="codefund"></div></div> <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>React源码</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/MVVMDoc/MVVM/React/Code/" class="active sidebar-link">React 源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MVVMDoc/MVVM/React/Code/#理念" class="sidebar-link">理念</a></li><li class="sidebar-sub-header"><a href="/MVVMDoc/MVVM/React/Code/#源码学习三个阶段" class="sidebar-link">源码学习三个阶段</a></li><li class="sidebar-sub-header"><a href="/MVVMDoc/MVVM/React/Code/#fiber-架构" class="sidebar-link">Fiber 架构</a></li><li class="sidebar-sub-header"><a href="/MVVMDoc/MVVM/React/Code/#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/MVVMDoc/MVVM/React/Code/#hook-是如何保存数据" class="sidebar-link">Hook 是如何保存数据</a></li><li class="sidebar-sub-header"><a href="/MVVMDoc/MVVM/React/Code/#多个是怎么保存的" class="sidebar-link">多个是怎么保存的</a></li><li class="sidebar-sub-header"><a href="/MVVMDoc/MVVM/React/Code/#usestate-执行流程" class="sidebar-link">useState 执行流程</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="react-源码"><a href="#react-源码" aria-hidden="true" class="header-anchor">#</a> React 源码</h1> <h2 id="理念"><a href="#理念" aria-hidden="true" class="header-anchor">#</a> 理念</h2> <p>React 的 调用栈分三个层次</p> <ul><li>Scheduler（调度器）—— 调度任务的优先级，高优任务优先进入<strong>Reconciler</strong></li> <li>Reconciler（协调器）—— 负责找出变化的组件</li> <li>Renderer（渲染器）  —— 负责将变化的组件渲染到页面上</li></ul> <p><strong>React意在 构建快速响应的大型Web应用程序。所以最重要的问题就是解决 CPU 和 IO 的瓶颈问题。也就是新版的并发的更新模式代替以前的同步更新模式。Fiber架构能实现并发更新。</strong></p> <h2 id="源码学习三个阶段"><a href="#源码学习三个阶段" aria-hidden="true" class="header-anchor">#</a> 源码学习三个阶段</h2> <ul><li>首先从 Build you Own React [https://pomb.us/build-your-own-react/]</li> <li>熟悉到 React的理念</li> <li>参考别人的React源码解析</li> <li>自己从头到尾认真的读一遍</li></ul> <h2 id="fiber-架构"><a href="#fiber-架构" aria-hidden="true" class="header-anchor">#</a> Fiber 架构</h2> <h2 id="定义"><a href="#定义" aria-hidden="true" class="header-anchor">#</a> 定义</h2> <p>React Hook 从具象来说就为函数组件（纯函数）提供副作用能力的 React API，确定状态源的解决方案。</p> <ul><li>在组件之间复用状态逻辑很难（高阶组件、render props 代码难以理解 嵌套深）</li> <li>复杂组件难以理解</li> <li>class 难以理解 this指向</li></ul> <h2 id="hook-是如何保存数据"><a href="#hook-是如何保存数据" aria-hidden="true" class="header-anchor">#</a> Hook 是如何保存数据</h2> <p>FC 的 render 本身只是函数调用，<strong>每个组件都有对应的 fiber 节点（可以理解为虚拟DOM），用于保存组件相关信息，每次组件 Render时，全局变量<code>currentlyRenderingFiber</code>都会被赋值为该<code>FunctionComponent</code>对应的<code>fiber节点</code>。</strong> 所以 hook 内部其实是从 currentlyRenderingFiber 中获取状态信息的。</p> <h2 id="多个是怎么保存的"><a href="#多个是怎么保存的" aria-hidden="true" class="header-anchor">#</a> 多个是怎么保存的</h2> <p><code>currentlyRenderingFiber.memoizedState</code>中保存一条<code>hook</code>对应数据的单向链表。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> HookA <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// hook 保存的数据</span>
    memoizedState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 下一个hook</span>
    next<span class="token punctuation">:</span> hookB<span class="token punctuation">,</span>
    <span class="token comment">// 本次更新开始时已经有 update队列</span>
    baseState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 本次更新开始有 update 队列</span>
    baseQueue<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 本次更新需要增加的 update 队列</span>
    queue<span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

hookB<span class="token punctuation">.</span>next <span class="token operator">=</span> hookC<span class="token punctuation">;</span>

currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hookA<span class="token punctuation">;</span>
</code></pre></div><p>当<code>FunctionComponent</code> <code>render</code>时，每执行到一个<code>hook</code>，都会将指向<code>currentlyRenderingFiber.memoizedState</code>链表的指针向后移动一次，指向当前<code>hook</code>对应数据。</p> <p>这也是为什么<code>React</code>要求<code>hook</code>的调用顺序不能改变（不能在条件语句中使用<code>hook</code>） —— 每次<code>render</code>时都是从一条固定顺序的链表中获取<code>hook</code>对应数据的。</p> <h2 id="usestate-执行流程"><a href="#usestate-执行流程" aria-hidden="true" class="header-anchor">#</a> useState 执行流程</h2> <p><code>useState</code>返回值数组第二个参数为<strong>改变state的方法</strong>。</p> <p>在源码中，他被称为<code>dispatchAction</code>。每当调用<code>dispatchAction</code>，都会创建一个代表一次更新的对象<code>update</code> 如果是多次， <code>update</code>会形成一条环状链表。<code>update</code>链表是由某个<code>useState</code>的<code>dispatchAction</code>产生，那么这条链表显然属于该<code>useState hook</code>。</p> <p>其中，<code>queue</code>中保存了本次更新<code>update</code>的链表。</p> <p>在计算<code>state</code>时，会将<code>queue</code>的环状链表剪开挂载在<code>baseQueue</code>最后面，<code>baseQueue</code>基于<code>baseState</code>计算新的<code>state</code>。</p> <p>在计算<code>state</code>完成后，新的<code>state</code>会成为<code>memoizedState</code>。</p> <blockquote><p>为什么更新不基于<code>memoizedState</code>而是<code>baseState</code>，是因为<code>state</code>的计算过程需要考虑优先级，可能有些<code>update</code>优先级不够被跳过。所以<code>memoizedState</code>并不一定和<code>baseState</code>相同。</p></blockquote></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/facebook201/MVVMDoc/edit/master/docs/MVVM/React/Code/README.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div></div></div>
    <script src="/MVVMDoc/assets/js/app.0ce0ee86.js" defer></script><script src="/MVVMDoc/assets/js/7.f7d9a218.js" defer></script>
  </body>
</html>
